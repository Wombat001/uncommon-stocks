<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tay C-W">
<meta name="dcterms.date" content="2025-03-10">

<title>Aftermath: How it would all end – uncommon stocks</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-6bd9cfa162949bde0a231f530c97869d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">uncommon stocks</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.instagram.com/"> <i class="bi bi-instagram" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Aftermath: How it would all end</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">news</div>
                <div class="quarto-category">code</div>
                <div class="quarto-category">analysis</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Tay C-W </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 10, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="part-1---the-changing-market-conditions" class="level4">
<h4 class="anchored" data-anchor-id="part-1---the-changing-market-conditions">Part 1 - The changing market conditions</h4>
<p>With the election and inauguration of Donald Trump as the 47th president of the United States, <strong>Robinhood</strong> saw its full year earnings going through the roof since shedding 80% of its market capitalization in the wake of its IPO. Stock performance exceeded more than 400% and exceeding that of its peers. Most recently in February and March 2025, it was trading 40% higher than its IPO price, and a market value approaching $50 billion.</p>
<p>Although still comparatively young compared to platforms such as <em>Interactive Brokers</em> and <em>Charles Schwab</em>, from what started out as a <em>meme-stock</em> gig it has rapidly grown into a more mature financial services platform to include new product offerings such as fractional shares, crypto-currencies, and futures trading as well as enhanced features like a desktop app for more dedicated traders and a credit card as part of its gold services .</p>
<p><img src="image01.png" alt="drawing" width="720" height="480"></p>
<p>This has no doubt increased its appeal among its core user base of young male investors with a strong inclination for exotic and highly lucrative yet volatile assets.</p>
<p><img src="image02.png" alt="drawing" width="720" height="480"></p>
<p><img src="image03.png" alt="drawing" width="720" height="480"></p>
</section>
<section id="part-2---future-trends-and-performance" class="level4">
<h4 class="anchored" data-anchor-id="part-2---future-trends-and-performance">Part 2 - Future Trends and Performance</h4>
</section>
<section id="how-moomoo-makes-money-revenue-model-analysis" class="level1">
<h1>How Moomoo Makes Money: Revenue Model Analysis</h1>
<p>As a financial analyst examining Moomoo’s business model, I’ve identified and visualized the key revenue streams that power the platform’s growth.</p>
<section id="primary-revenue-streams" class="level2">
<h2 class="anchored" data-anchor-id="primary-revenue-streams">Primary Revenue Streams</h2>
<p>Moomoo’s revenue model is multi-faceted, with six distinct revenue channels:</p>
<ol type="1">
<li><strong>Commission Fees (45% of revenue)</strong>
<ul>
<li>Core revenue from stock and options trading fees</li>
<li>Commission rates vary by market but are generally competitive</li>
<li>Fee structure designed to encourage frequent trading</li>
<li>Commission revenue still dominates despite industry-wide pressure on fees</li>
</ul></li>
<li><strong>Interest Income (30% of revenue)</strong>
<ul>
<li>Generated from margin lending to customers for leveraged trading</li>
<li>Interest on uninvested cash balances in customer accounts</li>
<li>Growing segment as user assets increase and interest rates normalize</li>
<li>Lower volatility revenue stream that stabilizes quarterly results</li>
</ul></li>
<li><strong>Payment for Order Flow (10% of revenue)</strong>
<ul>
<li>Revenue from routing customer orders to specific market makers</li>
<li>Less significant than US-focused competitors due to regulatory differences in APAC</li>
<li>Subject to varying regulatory treatment across different operating markets</li>
</ul></li>
<li><strong>Subscription Services (8% of revenue)</strong>
<ul>
<li>Premium data packages and advanced analytical tools</li>
<li>Real-time market data subscriptions</li>
<li>Fastest growing segment (35% YoY)</li>
<li>High-margin revenue with strong customer retention</li>
</ul></li>
<li><strong>Currency Exchange (5% of revenue)</strong>
<ul>
<li>FX spread revenue from multi-currency trading across different exchanges</li>
<li>Particularly important in APAC where cross-border investing is common</li>
</ul></li>
<li><strong>Other Services (2% of revenue)</strong>
<ul>
<li>IPO distribution fees</li>
<li>Corporate services</li>
<li>Ancillary financial products</li>
</ul></li>
</ol>
</section>
<section id="geographic-revenue-distribution" class="level2">
<h2 class="anchored" data-anchor-id="geographic-revenue-distribution">Geographic Revenue Distribution</h2>
<p>Moomoo’s revenue sources are geographically diverse: - Hong Kong remains the largest market (42% of revenue) - Singapore has grown rapidly to 28% of revenue - US operations contribute 14% despite intense competition - Australia (9%) and Japan (4%) represent newer growth markets - This geographic diversification has reduced regulatory concentration risk</p>
</section>
<section id="revenue-growth-trajectory" class="level2">
<h2 class="anchored" data-anchor-id="revenue-growth-trajectory">Revenue Growth Trajectory</h2>
<p>The quarterly revenue chart demonstrates several key trends: - Consistent growth with CQGR of 7.2% - Year-over-Year growth of 47.1% (Q3 2023 to Q3 2024) - Quarterly revenue has more than doubled from $238M in Q1 2022 to $487M in Q3 2024 - Seasonal patterns with stronger performance in Q4/Q1 - Revenue acceleration correlates with expansion into new APAC markets</p>
</section>
<section id="key-performance-metrics" class="level2">
<h2 class="anchored" data-anchor-id="key-performance-metrics">Key Performance Metrics</h2>
<p>Several important revenue metrics highlight Moomoo’s monetization efficiency: - Annual Revenue Per User (ARPU) of $208, up 18% YoY - Daily average revenue per active user of $8.20 - Interest revenue representing 3.2% of AUM - Transaction revenue as percentage of trading volume declining slightly as other revenue streams grow</p>
</section>
<section id="strategic-revenue-evolution" class="level2">
<h2 class="anchored" data-anchor-id="strategic-revenue-evolution">Strategic Revenue Evolution</h2>
<p>Moomoo’s revenue model is strategically evolving: 1. <strong>Reduced Commission Dependency</strong>: Gradually decreasing reliance on trading commissions 2. <strong>Growing Recurring Revenue</strong>: Increasing focus on subscription services and interest income 3. <strong>Geographic Diversification</strong>: Expanding into new markets to reduce concentration risk 4. <strong>Premium Service Upsell</strong>: Leveraging technology advantage to create premium offerings 5. <strong>Wealth Management Expansion</strong>: Beginning to monetize non-trading financial services</p>
<p>This diversified approach has allowed Moomoo to maintain strong growth despite industry-wide pressure on trading commissions, positioning the company for sustainable long-term revenue expansion across the APAC region.</p>
<p>Would you like me to provide more detailed analysis on any specific aspect of Moomoo’s revenue model?</p>
<p><img src="image04.png" alt="drawing" width="720" height="420"></p>
<p>Both <strong>Robinhood</strong> and <strong>Moomoo</strong> would experience churn in their user base as already fickle investors get more expectant and move to other platforms while recent and upcoming players compete for the same market segment, further adding pressure to their bottomline. Coincidentally the common strategy for either of them is some or all of the following:</p>
<ol type="1">
<li><strong>Reducing dependency on commission income</strong> which currently makes up the majority of all revenue streams.</li>
<li><strong>Growing recurring revenue</strong> by increasing the weight or moving to a subscription based model for its clients</li>
<li><strong>Diversifying markets</strong> by expanding into new emergent geographies, preferrably with young demographics hungry to invest</li>
<li><strong>Investing in innovation &amp; automation</strong> to drive down manpower costs</li>
<li><strong>Offering new products and financial services</strong> such as cryptos, wealth management, holding accounts, etc.</li>
<li><strong>Exploring strategic partnerships</strong> with other financial service companies to offer complementary services</li>
</ol>
<p>When <strong>Robinhood</strong> reports full-year earnings on Wednesday, it will mark a coming of age for the engine of 2021’s fleeting meme stock mania.</p>
<p>Analysts anticipate fourth-quarter profits of more than double any previous quarter off the back of a blowout period for rivals. The online broker is expected to report its first-ever annual profit, more than three years after it first went public.</p>
<p><img src="image05.png" alt="drawing" width="720" height="420"></p>
<p><img src="image06.png" alt="drawing" width="720" height="420"></p>
<p>After shedding 80 per cent of its market capitalisation in the wake of its IPO, its shares have more than quadrupled over the past year, far outpacing rivals such as Interactive Brokers and Charles Schwab. It now trades 40 per cent above its IPO price, with a market value closing in on $50bn.</p>
<p>“The maturation of <strong>Robinhood</strong> has coincided with the maturation of the retail investor,” said Patrick Moley, an analyst at Piper Sandler. “They’ve been working on their product road map, so as retail trading has accelerated, they had these . . . pieces in place.”</p>
<p><strong>Robinhood</strong> has evolved from an app that sprayed digital confetti when customers made their first trade to one that aims to serve as a broader financial services platform.</p>
<p>Its founder Vlad Tenev has set ambitious goals for the broker’s expansion. “We expect to get to number one in options before 2027, number one in equities before 2029,” he said at the company’s first investor day in December. “This is just one piece of a much larger picture.”</p>
<p>Revenues from trading have not yet recovered to the peak reached during 2021’s meme-stock mania. But since 2022, its earnings have been bolstered by rising interest rates, which have helped it earn interest on its own deposits as well as boosting its cash sweep programme, where it collects fees from customers who earn interest on their unused funds.&nbsp;</p>
<p>Last year, it added futures trading and a desktop app for more serious traders, as well as a credit card with a 2mn-strong wait list under its fee-paying “Gold” service.</p>
<p>“The card is the one that generates a lot of envy and interest around the office,” said Benjamin Budish, an analyst at Barclays who switched to an “overweight” rating on the stock in September.</p>
<p>A <strong>Robinhood</strong> Gold card currently offers an industry-leading 3 per cent cashback on all purchases, and select clients can apply for a solid gold version.</p>
<p>“We’re not yet seeing it driving a ton of revenues, but that wait-list is a lot of people who can become fee-paying clients,” Budish added. “With that, maybe they become equity clients — they maybe trade options. And then this platform approach starts to make more and more sense.”</p>
<p>For the quarter it is about to report, analysts expect $535mn in transaction-related revenues, according to LSEG data&nbsp;— a number that would finally surpass the meme-mania peak.</p>
<p>By now the primary revenue source would not be stock trading, or even options, hitherto the largest provider of income, but from a surge in crypto trading income from $61mn to $320mn, undoubtedly thanks to Trump’s return to the White House as well as his crypto-friendly statements.</p>
<p>A prospective boom in crypto trading, no doubt thanks to president Trump, among other reasons has been one of the factors underpinning price growth in <strong>Robinhood</strong>’s shares, even outclimbing that of Coinbase. Shares of Coinbase jumped almost 50%, making it worth $70bn in the market, while shares of <strong>Robinhood</strong> increased more than 2 times in as many months since the presidential elections in the US.</p>
<p>Although offering only a tenth of the tokens made available by coinbase, <strong>Robinhood</strong>’s strategy seems to resonate more with the moderate investors who are able to buy options of major Nasdaq companies, trade the latest in trend meme stock, in addition to the most popular crypto assets in the market. “That’s a model that I think is going to be successful for them over the next several years” opined Moley of Piper Sandler.</p>
<p>In addition, <strong>Robinhood</strong> also acquired the crypto exchange Bitstamp for $200mn, in a deal that would allow it to launch staking service, a practice to enable coin owners to earn a return from verifying other transactions through their holdings. An extra advantage of this acquisition is the in-principle approval for trading in Singapore as well as licenses in Europe Bitstamp carries with it, which allows Robinhood to expand in the EU and APAC in the not-too-distant future.</p>
<p><strong>Robinhood</strong> is expected to double down in its crypto assets offerings as well as services, potentially reaping the benefits of crypto regulatory changes from the White House.</p>
<section id="part-3---headwinds" class="level4">
<h4 class="anchored" data-anchor-id="part-3---headwinds">Part 3 - Headwinds</h4>
<p>Young startups like <strong>Robinhood</strong> and <strong>Moomoo</strong> remain relative small fries in the space of trading and brokering where financial muscle and industrial connections are key elements to survive. For example <strong>Interactive Brokers</strong>, commonly seen as the most direct competitor to both platforms held close to 3 times more assets under custody than <strong>Robinhood</strong> and purportedly at least 10 times more than <strong>Moomoo</strong></p>
<p>In general, retail trading platforms face greater competitive pressure from larger wealth management rivals such as Fidelity, Charles Schwab that have the wherewithal to not only offer a much greater range of investment products and opportunities, but also possess the requisite financial buffer and market mass to withstand higher volatility and black swan events.</p>
<p>This means platform companies have to remain highly nimble and innovative, including putting up ever more volatile and riskier assets, and products in order to retain client interest while attempting to build up the user base and assets under custody to fend off bigger rivals and withstand shocks to the markets</p>
<p>Over the next years, <strong>Robinhood</strong>’s and <strong>Moomoo’s</strong> traditional clients, the younger and more impulsive demographic that trades on social media vibes, might “graduate” to more stable portfolios with a longer investment horizon. This has been happening for major platforms where new retail investors there are under 30 are increasingly making up more than those under 40, and are expected to increase 3 fold in the next decade. Ultimately, the trend would stabilize, exibiting a balance of traders opting for conventional and newer platforms. This is however a disadvantage to the up-coming startups that rely on being <em>novel</em> with a sense of rebelliousness and catering to the ever-evolving tastes of the youthful demographic. A fixed and progressively less mobile market segment could be fatal to their user acquisition and uptake numbers. Furthermore, for newborn platforms that rely primarily on funding to finance their operations, a decreasing user base could dampen investor interest and slow their growth to eventual profitability.</p>
<p>Regulatory environment also plays a major role in the expansion of trading platforms. Regulatory and political scrutiny in China from 2021 has caused financial players to experience increased turbulence, from the halted listing plans of <strong>Ant Financial</strong> to the tightened control of money flow by major banks have put a damper to plans in-country by companies and accelerated their moves to expand overseas. The worsening political landscape on the mainland coupled with a sharply intensifying trade war between China and the US would force these startups to more political neutral regions where the fight over market share and the need to grow user base would only compound.</p>
<p>For Robinhood’s and Moomoo’s continued growth and stock performance, both have chosen to increase the type of product offerings such as factional shares, options, and cryptos - where it has a distinctive advantage among younger investors, as well as seeking growth in emergent markets in APAC where under-30s make up a proportionately greater size of the user base. An additional service that is rapidly garnering attention and greater interest is the potential of cross-border trading and settlement where an investor could invest in foreign assets while opting to settle in the local currency, reducing forex risk by a large extent. This not only opens up more mature markets in Europe and the US to Asian investors, it also allows these platforms to act as non-traditional settlement and accounting holding houses, and creating a secondary source of financial income. The downside is the greater regulatory scrutiny, not only from the financial regulators of the home base but also in jurisdications where the platforms are commercially active; something traditional brokerages actively avoid.</p>
</section>
<section id="references" class="level4">
<h4 class="anchored" data-anchor-id="references">References</h4>
<ol type="1">
<li><p>Robinhood Expects to Launch Crypto Products in Singapore in 2025, derived from <a href="https://www.bloomberg.com/news/articles/2025-02-18/robinhood-expects-to-launch-crypto-products-in-singapore-in-2025">link</a></p></li>
<li><p>China Broker Futu Cuts 5% of Staff on Global Strategy Shift, derived from <a href="https://www.bloomberg.com/news/articles/2024-11-21/hinese-broker-futu-cuts-5-of-staff-as-global-expansion-slows">link</a></p></li>
<li></li>
</ol>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>